/*
  MONITOR: De temperatura con alerta sonora (BUZZER EN PIN 25)
  Placa: Arduino Mega 2560
  
  LÓGICA:
  - Si Temp >= x.0 C -> ALERTA (Buzzer ON).
*/

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>

// --- 1. CONFIGURACIÓN PANTALLA ---
#define ANCHO 128
#define ALTO 64
Adafruit_SSD1306 display(ANCHO, ALTO, &Wire, -1);

// --- 2. CONFIGURACIÓN PINES ---
const int buzzerPin = 25; 
const int ledFantasma = 41; 

// --- 3. CONFIGURACIÓN DHT11 ---
#define DHTPIN 23     
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// Variables Globales
float temperatura = 0;
float humedad = 0;

// UMBRAL
const float tempUmbral = 27.0;

void setup() {
  Serial.begin(9600);

  // Iniciar Pantalla
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println(F("Error Pantalla"));
    }
  }
  
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.display();

  // Configurar Pines
  pinMode(buzzerPin, OUTPUT);
  noTone(buzzerPin); 

  pinMode(ledFantasma, OUTPUT);    
  digitalWrite(ledFantasma, LOW);  

  dht.begin();
}

void loop() {
  // --- 1. LEER DATOS ---
  float t = dht.readTemperature();
  float h = dht.readHumidity();

  // --- LÓGICA DE SEGURIDAD (DETECTAR CORTE DE ENERGÍA) ---
  // Si t o h son "NaN" (Not a Number), significa que el sensor está apagado o fallando.
  if (isnan(t) || isnan(h)) {
    Serial.println(F("Sensor desconectado o sin energía"));
    
    // 1. ¡APAGAR BUZZER OBLIGATORIAMENTE!
    noTone(buzzerPin); 
    
    // 2. Mostrar aviso en pantalla
    display.clearDisplay();
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("- MONITOR TERMICO -");
    
    display.setTextSize(2);
    display.setCursor(0, 25);
    display.println("SENSOR OFF"); // Aviso visual
    
    display.display();
    
    // 3. Salir del loop aquí para no ejecutar la lógica de temperatura vieja
    delay(500);
    return; 
  }

 //--- 1. Lectura de datos ---
  temperatura = t;
  humedad = h;

  // --- 2. Pantalla normal ---
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("- MONITOR TERMICO -");

  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print("T: "); display.print(temperatura, 1); display.println(" C"); 

  display.setTextSize(1);
  display.setCursor(0, 45);
  display.print("Humedad: "); display.print((int)humedad); display.println("%");

  // --- 3. ALARMA ---
  if (temperatura >= tempUmbral) {
    tone(buzzerPin, 2000); 
    
    display.setCursor(0, 55);
    display.setTextSize(1);
    display.println("Estado: ! ALERTA !"); 
    display.drawRect(0, 53, 128, 11, WHITE);
    
  } else {
    noTone(buzzerPin);
    
    display.setCursor(0, 55);
    display.setTextSize(1);
    display.println("Estado: Normal");
  }

  display.display(); 
  digitalWrite(ledFantasma, LOW);
  delay(500);
}
