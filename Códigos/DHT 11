/*
  MONITOR: LED CONTROLADO POR TEMPERATURA
  Placa: Arduino Mega 2560
  
  LÓGICA:
  - Si Temperatura >= 23.0 C -> ENCIENDE LED (Pin 33).
  - Pantalla OLED: Muestra Temp (con decimal) y Humedad relativa.
  
  Librerias: 
  -DHT sensor library de Adafruit
  -Adafruit SSD1306
*/

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>

// --- 1. CONFIGURACIÓN PANTALLA ---
#define ANCHO 128
#define ALTO 64
Adafruit_SSD1306 display(ANCHO, ALTO, &Wire, -1);

// --- 2. CONFIGURACIÓN PINES ---
// Ultrasonido (Lo dejamos configurado por si está conectado)
const int trigPin = 29;
const int echoPin = 31;

// LED de Alerta (Pin 33 - Temperatura)
const int ledPin = 33; 

// LED Fantasma (Pin 41 - Movimiento)
// Lo definimos para poder apagarlo
const int ledFantasma = 41; 

// --- 3. CONFIGURACIÓN DHT11 ---
#define DHTPIN 23     
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// Variables Globales
float temperatura = 0;
float humedad = 0;

void setup() {
  Serial.begin(9600);

  // Iniciar Pantalla
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println(F("Error Pantalla"));
    }
  }
  
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.display();

  // Configurar Pines
  pinMode(trigPin, OUTPUT);
  pinMode(echoPin, INPUT);
  
  pinMode(ledPin, OUTPUT);
  digitalWrite(ledPin, LOW); // Asegurar apagado al inicio

  // --- CORRECCIÓN PIN 41 ---
  pinMode(ledFantasma, OUTPUT);    // Declaramos el pin 41 como salida
  digitalWrite(ledFantasma, LOW);  // Lo obligamos a estar APAGADO (Tierra)

  // Iniciar Sensor DHT11
  dht.begin();
}

void loop() {
  // --- 1. LEER DATOS DE CLIMA ---
  float t = dht.readTemperature();
  float h = dht.readHumidity();

  // Validar lectura
  if (!isnan(t)) temperatura = t;
  if (!isnan(h)) humedad = h;

  // --- 2. LÓGICA DE CONTROL DEL LED (Pin 33) ---
  // Encender si es mayor o igual a 23.0 C
  if (temperatura >= 23.0) {
    digitalWrite(ledPin, HIGH); 
  } else {
    digitalWrite(ledPin, LOW);  
  }

  // --- 3. MOSTRAR EN PANTALLA ---
  display.clearDisplay();
  
  // Título
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("- CONTROL TEMPERATURA -");

  // Temperatura (Con 1 decimal)
  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print("T: ");
  display.print(temperatura, 1); 
  display.println(" C"); 

  // Humedad
  display.setCursor(0, 45);
  display.print("H: ");
  display.print((int)humedad);
  display.println(" % Rh"); 

  display.display(); 
  
  // Reafirmar el apagado del pin 41 por seguridad en cada ciclo
  digitalWrite(ledFantasma, LOW);

  delay(500);
}
