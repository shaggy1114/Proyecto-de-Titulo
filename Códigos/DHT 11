/*
  MONITOR: De temperatura con alerta sonora (BUZZER EN PIN 25)
  Placa: Arduino Mega 2560
   
  LÓGICA:
  - Si Temp >= x.0 C -> ALERTA (Buzzer ON).
*/

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>
#include <DHT.h>

// --- 1. CONFIGURACIÓN PANTALLA ---
#define ANCHO 128
#define ALTO 64
Adafruit_SSD1306 display(ANCHO, ALTO, &Wire, -1);

// --- 2. CONFIGURACIÓN PINES ---
const int buzzerPin = 25; 

const int ledFantasma41 = 41; 
const int ledFantasma33 = 33; 

// --- 3. CONFIGURACIÓN DHT11 ---
#define DHTPIN 23      
#define DHTTYPE DHT11
DHT dht(DHTPIN, DHTTYPE);

// Variables Globales
float temperatura = 0;
float humedad = 0;

// UMBRAL
const float tempUmbral = 27.0;

void setup() {
  Serial.begin(9600);

  // Iniciar Pantalla
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println(F("Error Pantalla"));
    }
  }
   
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.display();

  // Configurar Pines
  pinMode(buzzerPin, OUTPUT);
  noTone(buzzerPin); 

  pinMode(ledFantasma41, OUTPUT);     
  digitalWrite(ledFantasma41, LOW);   

  pinMode(ledFantasma33, OUTPUT);     
  digitalWrite(ledFantasma33, LOW);   

  dht.begin();
}

void loop() {
  digitalWrite(ledFantasma41, LOW);
  digitalWrite(ledFantasma33, LOW);

  // --- 1. LEER DATOS ---
  float t = dht.readTemperature();
  float h = dht.readHumidity();

  // --- LÓGICA DE SEGURIDAD (DETECTAR CORTE DE ENERGÍA) ---
  if (isnan(t) || isnan(h)) {
    Serial.println(F("Sensor desconectado o sin energía"));
    
    noTone(buzzerPin); 
    
    display.clearDisplay();
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("- MONITOR TERMICO -");
    
    display.setTextSize(2);
    display.setCursor(0, 25);
    display.println("SENSOR OFF"); 
    
    display.display();
    
    delay(500);
    return; 
  }

  // Asignar valores válidos
  temperatura = t;
  humedad = h;

  // --- 2. PANTALLA NORMAL ---
  display.clearDisplay();
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("- MONITOR TERMICO -");

  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print("T: "); display.print(temperatura, 1); display.println(" C"); 

  display.setTextSize(1);
  display.setCursor(0, 45);
  display.print("Humedad: "); display.print((int)humedad); display.println("%");

  // --- 3. ALARMA ---
  if (temperatura >= tempUmbral) {
    tone(buzzerPin, 2000); 
    
    display.setCursor(0, 55);
    display.setTextSize(1);
    display.println("Estado: ! ALERTA !"); 
    display.drawRect(0, 53, 128, 11, WHITE);
    
  } else {
    noTone(buzzerPin); 
    
    display.setCursor(0, 55);
    display.setTextSize(1);
    display.println("Estado: Normal");
  }

  display.display(); 
  delay(500);
}
