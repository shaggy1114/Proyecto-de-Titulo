/*
  Monitoreo gas con alerta sonora
  Placa: Arduino Mega 2560
  
  Funciones:
  1. Lee MQ-135.
  2. Si valor > x -> ALERTA (Buzzer suena).
*/

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// --- 1. CONFIGURACIÓN PANTALLA ---
#define ANCHO 128
#define ALTO 64
Adafruit_SSD1306 display(ANCHO, ALTO, &Wire, -1);

// --- 2. CONFIGURACIÓN SENSORES ---
const int pinSensor = A2;   // MQ-135
const int pinBuzzer = 27;   // Buzzer
const int pinLedFantasma = 33; 

// --- 3. CALIBRACIÓN ---
const int umbralGas = 400; 

void setup() {
  Serial.begin(9600);

  // Iniciar Pantalla
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println(F("Error Pantalla OLED"));
    }
  }
  
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.display();

  // Configurar Pines
  pinMode(pinBuzzer, OUTPUT);
  noTone(pinBuzzer); 

  pinMode(pinLedFantasma, OUTPUT);
  digitalWrite(pinLedFantasma, LOW); 

  Serial.println("Sistema Iniciado");
  delay(2000); 
}

void loop() {
  // 1. Leer valor del gas
  int valorGas = analogRead(pinSensor);
  
  Serial.print("Gas: "); Serial.println(valorGas);

  // --- LÓGICA DE SEGURIDAD (SENSOR OFF) ---
  // Un MQ-135 funcionando, incluso en aire limpio, suele marcar entre 30 y 100.
  // Si marca menos de 10 (casi 0), es porque está apagado o desconectado.
  if (valorGas < 10) {
    // ¡APAGADO DE EMERGENCIA!
    noTone(pinBuzzer); 
    
    // Aviso en Pantalla
    display.clearDisplay();
    display.setTextSize(1);
    display.setCursor(0, 0);
    display.println("--- MONITOR GAS ---");
    
    display.setTextSize(2);
    display.setCursor(0, 25);
    display.println("SENSOR OFF"); 
    
    display.display();
    
    delay(500);
    return; // Salimos del loop para no ejecutar nada más
  }

  // --- Si el sensor esta encendido, sigue el loop ---

  display.clearDisplay();
  
  // Título
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("--- MONITOR GAS ---");

  // Valor
  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print("Nivel: ");
  display.println(valorGas);

  // Lógica de Alarma
  if (valorGas > umbralGas) {
    // --- PELIGRO ---
    tone(pinBuzzer, 1000); // Sonido Fuerte
    
    display.setCursor(0, 45);
    display.setTextSize(2);
    display.println("Nivel Alto");
    display.drawRect(0, 42, 128, 22, WHITE);
    
  } else {
    // --- NORMAL ---
    noTone(pinBuzzer);
    
    display.setCursor(0, 45);
    display.setTextSize(2);
    display.println("Nivel Bajo");
  }

  display.display();
  digitalWrite(pinLedFantasma, LOW);

  delay(500);
}
