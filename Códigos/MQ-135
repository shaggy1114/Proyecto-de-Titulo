/*
  MONITOR DE CALIDAD DE AIRE CON PANTALLA OLED
  Placa: Arduino Mega 2560
  
  Funciones:
  1. Lee sensor MQ-135 (Pin A2).
  2. Muestra nivel y mensaje de ALERTA en OLED.
  3. Activa Buzzer (Pin 27) si supera el umbral (Usa tone() para más volumen).
*/

#include <Wire.h>
#include <Adafruit_GFX.h>
#include <Adafruit_SSD1306.h>

// --- 1. CONFIGURACIÓN PANTALLA ---
#define ANCHO 128
#define ALTO 64
Adafruit_SSD1306 display(ANCHO, ALTO, &Wire, -1);

// --- 2. CONFIGURACIÓN SENSORES ---
const int pinSensor = A2;   // Entrada del MQ-135
const int pinBuzzer = 27;   // Salida del Buzzer
const int pinLedFantasma = 33; 

// --- 3. CALIBRACIÓN ---
// Ajustar segun lo requerido (ej. 250, 400, etc.)
const int umbralGas = 250; 

void setup() {
  Serial.begin(9600);

  // --- INICIAR PANTALLA ---
  if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3C)) { 
    if(!display.begin(SSD1306_SWITCHCAPVCC, 0x3D)) {
      Serial.println(F("Error Pantalla OLED"));
      // Continuamos aunque falle la pantalla
    }
  }
  
  display.clearDisplay();
  display.setTextColor(WHITE);
  display.display();

  // --- CONFIGURAR PINES ---
  pinMode(pinBuzzer, OUTPUT);
  noTone(pinBuzzer); // Aseguramos silencio al inicio usando noTone

  // CORRECCIÓN: e
  pinMode(pinLedFantasma, OUTPUT);
  digitalWrite(pinLedFantasma, LOW); 

  Serial.println("Sensor de Gas Iniciado");
  delay(2000); // Tiempo para precalentar sensor
}

void loop() {
  // 1. Leer valor del gas
  int valorGas = analogRead(pinSensor);
  
  // 2. Imprimir en Serial (para calibrar)
  Serial.print("Gas: ");
  Serial.println(valorGas);

  // 3. PREPARAR PANTALLA
  display.clearDisplay();
  
  // Título
  display.setTextSize(1);
  display.setCursor(0, 0);
  display.println("--- MONITOR GAS ---");

  // Mostrar Valor Numérico
  display.setTextSize(2);
  display.setCursor(0, 20);
  display.print("Nivel: ");
  display.println(valorGas);

  // 4. LÓGICA DE ALARMA Y MENSAJE
  if (valorGas > umbralGas) {
    // --- CASO PELIGRO (> 250) ---
    
    // Activar Sonido
    // Usamos tone() con 1000Hz o 2000Hz para maximizar el volumen en buzzers pasivos
    tone(pinBuzzer, 1000); 
    
    // Mostrar Alerta en Pantalla
    display.setCursor(0, 45);
    display.setTextSize(2);
    display.println("Nivel Alto"); // TEXTO MODIFICADO
    
    // Dibujar un recuadro de advertencia (estético)
    display.drawRect(0, 42, 128, 22, WHITE);
    
  } else {
    // --- CASO NORMAL (<= 250) ---
    
    // Apagar Sonido
    noTone(pinBuzzer); // Usamos noTone para detener el sonido
    
    // Mostrar Estado Normal
    display.setCursor(0, 45);
    display.setTextSize(2); // Aumentado a tamaño 2 para mejor lectura
    display.println("Nivel Bajo"); // TEXTO MODIFICADO
  }

  // 5. ACTUALIZAR PANTALLA
  display.display();
  
  // 6. Volver a asegurar que el LED 33 esté apagado (por seguridad)
  digitalWrite(pinLedFantasma, LOW);

  delay(500);
}
